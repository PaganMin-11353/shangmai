<header class="site-header" id="site-header">
    <div class="container">
        <div class="header-content">
            <!-- Logo -->
            <a href="{{ relLangURL "/" }}" class="site-logo" aria-label="{{ i18n "aria_goto_homepage" }}">
                {{ if .Site.Params.logo }}
                    <img src="{{ .Site.Params.logo }}" alt="{{ .Site.Title }}" loading="eager" class="logo-main">
                    <img src="/images/logo/logo-short.gif" alt="{{ .Site.Title }}" loading="eager" class="logo-compact">
                {{ else }}
                    {{ .Site.Title }}
                {{ end }}
            </a>
            
            <!-- Main Navigation -->
            <nav class="main-nav" id="main-nav" role="navigation" aria-label="{{ i18n "aria_main_navigation" }}">
                {{ if .Site.Menus.main }}
                    {{ range .Site.Menus.main }}
                        <a href="{{ .URL }}" 
                           class="nav-link {{ if $.IsMenuCurrent "main" . }}active{{ end }}"
                           {{ if .Page }}aria-current="page"{{ end }}>
                            {{ .Name }}
                        </a>
                    {{ end }}
                {{ else }}
                    <!-- Fallback navigation if no menu is defined -->
                    <a href="{{ relLangURL "/" }}" class="nav-link {{ if .IsHome }}active{{ end }}">{{ i18n "nav_home_fallback" }}</a>
                    <a href="{{ "/products/" | relLangURL }}" class="nav-link {{ if eq .Section "products" }}active{{ end }}">{{ i18n "nav_products_fallback" }}</a>
                    <a href="{{ "/about/" | relLangURL }}" class="nav-link {{ if eq .Section "about" }}active{{ end }}">{{ i18n "nav_about_fallback" }}</a>
                    <a href="{{ "/contact/" | relLangURL }}" class="nav-link {{ if eq .Section "contact" }}active{{ end }}">{{ i18n "nav_contact_fallback" }}
                {{ end }}
                
                <!-- Mobile Language Switcher -->
                <div class="mobile-lang-switcher mobile-only">
                    <div class="lang-separator"></div>
                    {{ range .Site.Languages }}
                        {{ $url := "" }}
                        {{ if or $.IsHome (eq $.Section "tech") (eq $.Section "news") (eq $.Section "products") (eq $.Section "opportunities") }}
                            {{ $url = printf "/%s/" .Lang }}
                        {{ else }}
                            {{ $url = $.RelPermalink | relLangURL }}
                        {{ end }}
                        <a href="{{ $url }}" 
                           class="mobile-lang-link {{ if eq .Lang $.Site.Language.Lang }}current{{ end }}">
                            <span class="flag">{{ .Params.flag }}</span>
                            <span class="name">{{ .LanguageName }}</span>
                            {{ if eq .Lang $.Site.Language.Lang }}
                                <span class="checkmark">✓</span>
                            {{ end }}
                        </a>
                    {{ end }}
                </div>
                
            </nav>
            
            <!-- Language Switcher (Desktop) -->
            <div class="language-switcher desktop-only" id="language-switcher">
                <button class="lang-button" 
                        id="lang-button"
                        aria-expanded="false" 
                        aria-haspopup="true"
                        aria-label="{{ i18n "aria_select_language" }}">
                    <span class="current-flag">{{ .Site.Language.Params.flag }}</span>
                    <span class="current-lang">{{ .Site.Language.LanguageName }}</span>
                    <svg class="dropdown-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                <ul class="lang-dropdown" 
                    id="lang-dropdown" 
                    role="menu" 
                    aria-labelledby="lang-button">
                    {{ range .Site.Languages }}
                        {{ $url := "" }}
                        {{ if or $.IsHome (eq $.Section "tech") (eq $.Section "news") (eq $.Section "products") (eq $.Section "opportunities") }}
                            {{ $url = printf "/%s/" .Lang }}
                        {{ else }}
                            {{ $url = $.RelPermalink | relLangURL }}
                        {{ end }}
                        <li role="none">
                            <a href="{{ $url }}" 
                               class="lang-option {{ if eq .Lang $.Site.Language.Lang }}current{{ end }}"
                               role="menuitem"
                               {{ if eq .Lang $.Site.Language.Lang }}aria-current="true"{{ end }}>
                                <span class="flag">{{ .Params.flag }}</span>
                                <span class="name">{{ .LanguageName }}</span>
                                {{ if eq .Lang $.Site.Language.Lang }}
                                    <span class="checkmark">✓</span>
                                {{ end }}
                            </a>
                        </li>
                    {{ end }}
                </ul>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-nav-toggle" 
                    id="mobile-nav-toggle" 
                    aria-label="{{ i18n "aria_toggle_menu" }}"
                    aria-expanded="false"
                    aria-controls="main-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
    
    <!-- Mobile Navigation Backdrop -->
    <div class="mobile-nav-backdrop" id="mobile-nav-backdrop"></div>
</header>

<style>
/* Header Base Styles */
.site-header {
    position: sticky;
    top: 0;
    background-color: white;
    border-bottom: 1px solid #e5e7eb;
    z-index: 80;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    --nav-width: 400px;
    --lang-switcher-width: 120px;
    --gaps-and-padding: 4rem;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
    min-height: 70px;
    gap: 1rem;
}

.site-header .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Logo Styling */
.site-logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
    min-width: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}

.site-logo img {
    height: 56px;
    width: auto;
    max-width: calc(100vw - var(--nav-width) - var(--lang-switcher-width) - var(--gaps-and-padding));
    max-width: min(calc(100vw - var(--nav-width) - var(--lang-switcher-width) - var(--gaps-and-padding)), 400px);
    transition: all 0.3s ease;
    object-fit: contain;
    flex-shrink: 0;
}

/* Responsive Logo System */
.logo-compact {
    display: none;
}

.logo-main {
    display: block;
}

/* Desktop Navigation */
.main-nav {
    display: flex;
    align-items: center;
    gap: clamp(0.8rem, 2vw, 1.5rem);
    flex-wrap: nowrap;
    justify-content: flex-end;
    flex-shrink: 0;
    white-space: nowrap;
    min-width: var(--nav-width);
    overflow: hidden;
}

.nav-link {
    color: #374151;
    text-decoration: none;
    font-weight: 500;
    padding: 0.5rem 0;
    transition: color 0.3s ease;
    position: relative;
    white-space: nowrap;
    flex-shrink: 0;
}

.nav-link:hover {
    color: #0B5FFF;
}

.nav-link.active {
    color: #0B5FFF;
}

.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #0B5FFF;
    color: white;
    text-decoration: none;
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn:hover {
    background: #0046CC;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

/* Mobile Menu Toggle */
.mobile-nav-toggle {
    display: none;
    flex-direction: column;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 75;
    position: relative;
}

.mobile-nav-toggle span {
    display: block;
    width: 22px;
    height: 2px;
    background-color: #374151;
    margin: 2px 0;
    transition: all 0.3s ease;
    transform-origin: center;
}

.mobile-nav-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translate(3px, 3px);
}

.mobile-nav-toggle.active span:nth-child(2) {
    opacity: 0;
    transform: scale(0);
}

.mobile-nav-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translate(3px, -3px);
}

/* Mobile Navigation Backdrop */
.mobile-nav-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 65;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.mobile-nav-backdrop.active {
    display: block;
    opacity: 1;
}

/* Medium Desktop - Prevent logo clipping before mobile breakpoint */
@media (max-width: 1400px) and (min-width: 1201px) {
    .site-header {
        --nav-width: 360px;
        --lang-switcher-width: 110px;
    }
    
    .main-nav {
        gap: clamp(0.6rem, 1.5vw, 1.2rem);
        min-width: var(--nav-width);
    }
    
    .nav-link {
        font-size: 0.95rem;
    }
}

/* Tablet/Large Mobile - Hide nav when text starts to overflow */
@media (max-width: 1200px) {
    .site-header {
        --nav-width: 80px; /* Just mobile toggle button */
        --lang-switcher-width: 0px; /* Hidden in mobile menu */
    }
    
    .site-header .container {
        padding: 0 1rem;
    }
    
    .header-content {
        min-height: 64px;
        padding: 0.75rem 0;
    }
    
    .site-logo img {
        height: 48px;
        width: auto;
        max-width: calc(100vw - var(--nav-width) - var(--gaps-and-padding));
        max-width: min(calc(100vw - var(--nav-width) - var(--gaps-and-padding)), 300px);
        object-fit: contain;
    }
    
    .mobile-nav-toggle {
        display: flex;
    }
    
    .main-nav {
        position: fixed;
        top: 0;
        right: -100%;
        width: 320px;
        height: 100vh;
        background-color: white;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 6rem 2rem 2rem 2rem;
        gap: 0;
        transition: right 0.3s ease;
        z-index: 9999;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        border-left: 1px solid #e5e7eb;
    }
    
    .main-nav.active {
        right: 0 !important;
    }
    
    .nav-link {
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
        font-size: 1.125rem;
        text-align: left;
    }
    
    .nav-link:last-of-type {
        border-bottom: 1px solid #e5e7eb;
    }
    
    .main-nav .btn {
        margin-top: 2rem;
        padding: 1rem 2rem;
        text-align: center;
        justify-self: stretch;
        width: 100%;
    }
}

/* Small Mobile - Switch to compact logo under 500px */
@media (max-width: 500px) {
    .site-header .container {
        padding: 0 0.5rem;
    }
    
    .site-logo {
        font-size: 1.1rem;
        max-width: none;
    }
    
    .logo-main {
        display: none;
    }
    
    .logo-compact {
        display: block;
        height: 32px;
        width: 32px;
        object-fit: contain;
    }
}

/* Very Small Mobile Adjustments */
@media (max-width: 375px) {
    .site-header .container {
        padding: 0 0.75rem;
    }
    
    .site-logo {
        font-size: 1rem;
        max-width: calc(100vw - 100px);
    }
    
    .site-logo img {
        height: 32px;
        width: auto;
        max-width: none;
        object-fit: contain;
    }
    
    .mobile-nav-toggle {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
    }
    
    .mobile-nav-toggle span {
        width: 18px;
    }
}

/* Extra Small Mobile (320px and below) */
@media (max-width: 320px) {
    .site-logo {
        font-size: 0.9rem;
        max-width: calc(100vw - 80px);
    }
    
    .site-logo img {
        height: 28px;
    }
}

/* Language Switcher Styles */
.language-switcher {
    position: relative;
    flex-shrink: 0;
    min-width: var(--lang-switcher-width);
}

.lang-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: none;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    color: #374151;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.lang-button:hover {
    border-color: #0B5FFF;
    background-color: #f8faff;
}

.lang-button:focus {
    outline: none;
    border-color: #0B5FFF;
    box-shadow: 0 0 0 3px rgba(11, 95, 255, 0.1);
}

.lang-button .current-flag {
    font-size: 1rem;
    line-height: 1;
}

.lang-button .current-lang {
    font-size: 0.875rem;
}

.dropdown-icon {
    transition: transform 0.2s ease;
    color: #6b7280;
}

.lang-button[aria-expanded="true"] .dropdown-icon {
    transform: rotate(180deg);
}

/* Language Dropdown */
.lang-dropdown {
    position: absolute;
    top: calc(100% + 0.25rem);
    right: 0;
    min-width: 180px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
    list-style: none;
    margin: 0;
    padding: 0.5rem 0;
}

.lang-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.lang-dropdown li {
    margin: 0;
    padding: 0;
}

.lang-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: #374151;
    text-decoration: none;
    font-size: 0.875rem;
    transition: background-color 0.15s ease;
    border: none;
    width: 100%;
    position: relative;
}

.lang-option:hover {
    background-color: #f3f4f6;
}

.lang-option.current {
    background-color: #f0f9ff;
    color: #0B5FFF;
}

.lang-option .flag {
    font-size: 1rem;
    line-height: 1;
}

.lang-option .name {
    flex: 1;
    text-align: left;
}

.lang-option .checkmark {
    color: #0B5FFF;
    font-weight: bold;
    font-size: 0.875rem;
}

/* Mobile Language Switcher */
.mobile-lang-switcher {
    display: none;
}

.lang-separator {
    height: 1px;
    background-color: #e5e7eb;
    margin: 1rem 0;
}

.mobile-lang-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 0;
    color: #374151;
    text-decoration: none;
    font-size: 1rem;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.15s ease;
}

.mobile-lang-link:hover {
    background-color: #f9fafb;
    color: #0B5FFF;
}

.mobile-lang-link.current {
    color: #0B5FFF;
    background-color: #f0f9ff;
}

.mobile-lang-link .flag {
    font-size: 1.125rem;
    line-height: 1;
}

.mobile-lang-link .name {
    flex: 1;
    font-weight: 500;
}

.mobile-lang-link .checkmark {
    color: #0B5FFF;
    font-weight: bold;
}

/* Responsive Behavior */
.desktop-only {
    display: block;
}

.mobile-only {
    display: none;
}

@media (max-width: 1100px) {
    .desktop-only {
        display: none;
    }
    
    .mobile-only {
        display: block;
    }
    
    .mobile-lang-switcher {
        display: block;
        margin-top: 1rem;
    }
}

/* Focus States for Accessibility */
.nav-link:focus-visible,
.site-logo:focus-visible,
.mobile-nav-toggle:focus-visible,
.btn:focus-visible,
.lang-button:focus-visible,
.lang-option:focus-visible,
.mobile-lang-link:focus-visible {
    outline: 2px solid #0B5FFF;
    outline-offset: 2px;
    border-radius: 0.25rem;
}
</style>

<script>
// Mobile Navigation Toggle
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobile-nav-toggle');
    const mainNav = document.getElementById('main-nav');
    const backdrop = document.getElementById('mobile-nav-backdrop');
    
    console.log('Mobile menu elements found:', {
        toggle: !!mobileToggle,
        nav: !!mainNav, 
        backdrop: !!backdrop
    });
    
    if (mobileToggle && mainNav && backdrop) {
        function toggleMobileMenu() {
            const isActive = mainNav.classList.contains('active');
            console.log('Toggle menu - current state:', isActive ? 'open' : 'closed');
            
            if (isActive) {
                // Close menu
                mainNav.classList.remove('active');
                backdrop.classList.remove('active');
                mobileToggle.classList.remove('active');
                mobileToggle.setAttribute('aria-expanded', 'false');
                document.body.style.overflow = '';
                console.log('Menu closed');
            } else {
                // Open menu
                mainNav.classList.add('active');
                backdrop.classList.add('active');
                mobileToggle.classList.add('active');
                mobileToggle.setAttribute('aria-expanded', 'true');
                document.body.style.overflow = 'hidden';
                console.log('Menu opened');
            }
        }
        
        // Toggle menu on button click with improved event handling
        mobileToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mobile toggle clicked');
            toggleMobileMenu();
        });
        
        // Also listen for touchstart for better mobile responsiveness
        mobileToggle.addEventListener('touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mobile toggle touched');
            toggleMobileMenu();
        }, { passive: false });
        
        // Close menu when backdrop is clicked
        backdrop.addEventListener('click', toggleMobileMenu);
        
        // Close menu when nav link is clicked (including mobile language links)
        const allNavLinks = mainNav.querySelectorAll('.nav-link, .mobile-lang-link');
        allNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (mainNav.classList.contains('active')) {
                    toggleMobileMenu();
                }
            });
        });
        
        // Close menu on window resize if larger than mobile
        window.addEventListener('resize', () => {
            if (window.innerWidth > 1100 && mainNav.classList.contains('active')) {
                toggleMobileMenu();
            }
        });
        
        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mainNav.classList.contains('active')) {
                toggleMobileMenu();
            }
        });
    }
    
    // Language Switcher Functionality
    const langSwitcher = document.getElementById('language-switcher');
    const langButton = document.getElementById('lang-button');
    const langDropdown = document.getElementById('lang-dropdown');
    
    if (langSwitcher && langButton && langDropdown) {
        function toggleLanguageDropdown() {
            const isOpen = langDropdown.classList.contains('active');
            
            if (isOpen) {
                // Close dropdown
                langDropdown.classList.remove('active');
                langButton.setAttribute('aria-expanded', 'false');
            } else {
                // Open dropdown
                langDropdown.classList.add('active');
                langButton.setAttribute('aria-expanded', 'true');
            }
        }
        
        function closeLanguageDropdown() {
            langDropdown.classList.remove('active');
            langButton.setAttribute('aria-expanded', 'false');
        }
        
        // Toggle dropdown on button click
        langButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleLanguageDropdown();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!langSwitcher.contains(e.target)) {
                closeLanguageDropdown();
            }
        });
        
        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && langDropdown.classList.contains('active')) {
                closeLanguageDropdown();
                langButton.focus(); // Return focus to trigger
            }
        });
        
        // Keyboard navigation within dropdown
        const langOptions = langDropdown.querySelectorAll('.lang-option');
        langOptions.forEach((option, index) => {
            option.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = (index + 1) % langOptions.length;
                    langOptions[nextIndex].focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = (index - 1 + langOptions.length) % langOptions.length;
                    langOptions[prevIndex].focus();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    option.click();
                }
            });
        });
        
        // Focus first option when dropdown opens via keyboard
        langButton.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (!langDropdown.classList.contains('active')) {
                    toggleLanguageDropdown();
                }
                // Focus first option after dropdown opens
                setTimeout(() => {
                    const firstOption = langDropdown.querySelector('.lang-option');
                    if (firstOption) firstOption.focus();
                }, 50);
            }
        });
    }
});
</script>